{% extends 'base.html' %}
{% block title %}Dashboard - Traffic Congestion{% endblock %}
{% block head_extra %}
<style>
  .metrics-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin:20px 0;}
  .metric {background:#fff;padding:12px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.08);text-align:center;position:relative;}
  .metric h3 {margin:4px 0;font-size:14px;text-transform:uppercase;letter-spacing:.5px;color:#555;}
  .metric p {font-size:18px;margin:0;font-weight:600;color:#222;}
  .plots {display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;margin-top:20px;}
  .plots figure {margin:0;}
  .plots img {width:100%;background:#fff;padding:6px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.12);} 
  .downloads a {margin-right:12px;}
  .status-bar {display:flex;flex-wrap:wrap;align-items:center;gap:20px;margin-top:10px;font-size:13px;color:#555;}
  .badge {background:#3498db;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;}
  .chart-row {display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:24px;margin-top:30px;}
  .chart-box {min-height:300px;position:relative;}
  canvas {background:#fff;border:1px solid #eee;border-radius:6px;padding:8px !important;max-height:280px !important;}
  .shap-table th, .shap-table td {padding:6px 8px;border-bottom:1px solid #e2e2e2;font-size:13px;}
  .shap-table tr:last-child td {border-bottom:none;}
  .impact-bar {height:10px;border-radius:4px;background:linear-gradient(90deg,#e74c3c,#2ecc71);position:relative;}
  .impact-bar span {position:absolute;top:-4px;height:18px;width:2px;background:#222;}
  body.dark-mode .shap-table th, body.dark-mode .shap-table td {border-color:#2d3b48;}
  body.dark-mode .impact-bar {background:linear-gradient(90deg,#c0392b,#27ae60);} 
  .shap-table th {cursor:pointer;user-select:none;position:relative;}
  .shap-table th.sort-asc::after {content:'â–²';font-size:10px;position:absolute;right:6px;top:6px;color:#555;}
  .shap-table th.sort-desc::after {content:'â–¼';font-size:10px;position:absolute;right:6px;top:6px;color:#555;}
  .impact-wrap {background:#f0f2f5;border-radius:4px;position:relative;height:12px;overflow:hidden;}
  .impact-fill {height:100%;border-radius:4px;transition:width .25s;}
  body.dark-mode .impact-wrap {background:#2d3b48;}
  .cum-badge {display:inline-block;padding:2px 6px;border-radius:10px;font-size:11px;background:#eef2f6;color:#333;}
  body.dark-mode .cum-badge {background:#2d3f4d;color:#ddd;}
  #downloadShapCsv {margin-left:auto;}
  .spinner {width:14px;height:14px;border:2px solid #ccc;border-top-color:#3498db;border-radius:50%;animation:spin 0.7s linear infinite;display:inline-block;vertical-align:middle;margin-left:6px;}
  @keyframes spin {to{transform:rotate(360deg);}}
  table.version-table {border-collapse:collapse;width:100%;margin-top:25px;}
  table.version-table th, table.version-table td {border:1px solid #ddd;padding:6px 8px;font-size:12px;}
  body.dark-mode table.version-table th, body.dark-mode table.version-table td {border-color:#2d3b48;}
  #toastContainer {position:fixed;top:12px;right:12px;display:flex;flex-direction:column;gap:8px;z-index:9999;}
  .toast {background:#222;color:#fff;padding:10px 14px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.25);font-size:13px;opacity:0;transform:translateY(-6px);animation:toast-in .35s forwards;}
  .toast.success {background:#2e7d32;} .toast.error {background:#c0392b;} .toast.info {background:#2962ff;} .toast.warn {background:#b8860b;}
  @keyframes toast-in {to{opacity:1;transform:translateY(0);}}
</style>
{% endblock %}
{% block content %}
<h1>Model Performance Dashboard</h1>
<div class="status-bar">
  <span id="lastTrained">Last Trained: {% if metrics.trained_at %}{{ metrics.trained_at }}{% else %}â€”{% endif %}</span>
  <span class="badge" id="autoRefreshStatus">Auto Refresh: ON</span>
  <div class="downloads">
    <a class="btn small" href="/download/model">Download Model</a>
    <a class="btn small" href="/download/scaler">Download Scaler</a>
    <a class="btn small" href="/download/metrics">Download Metrics</a>
    {% if versions %}
    <div style="display:inline-block;">
      <select id="versionSelect" class="small">
        <option value="">Versions</option>
        {% for v in versions %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
      </select>
      <button id="downloadVersionBtn" class="btn small" type="button">Get</button>
    </div>
    {% endif %}
    <a class="btn small" href="/toggle-theme" title="Toggle Light/Dark">ðŸŒ“</a>
  </div>
</div>

<div style="margin:10px 0 25px;display:flex;flex-wrap:wrap;align-items:center;gap:25px;">
  <div>
    <label for="thresholdRange" style="font-size:12px;letter-spacing:.5px;">Probability Threshold</label><br>
    <input type="range" id="thresholdRange" min="0.05" max="0.95" step="0.01" value="{{ config.api.default_threshold if config.api and config.api.default_threshold else 0.5 }}" />
    <span id="thresholdValue" style="font-weight:600;margin-left:6px;">0.50</span>
  </div>
  <div>
    <button id="explainSampleBtn" class="btn small" type="button">Explain Random Sample</button>
  </div>
  <div style="display:flex;gap:8px;align-items:flex-end;">
    <button id="retrainBtn" class="btn small" type="button" title="Retrain using existing data">Retrain</button>
  <button id="retrainDataBtn" class="btn small" type="button" title="Regenerate data then retrain">Regenerate+Retrain</button>
    <span id="trainStatus" style="font-size:12px;color:#555;"></span>
  </div>
  <pre id="explainResult" class="code-panel" style="flex:1;min-width:300px;max-height:220px;overflow:auto;"></pre>
</div>

<div id="explainViz" style="display:none;flex-wrap:wrap;gap:18px;margin-bottom:25px;">
  <div class="card" style="min-width:150px;flex:1;">
    <h3 style="margin:0 0 4px;font-size:12px;letter-spacing:.5px;text-transform:uppercase;">Probability</h3>
    <p id="expProb" style="font-size:20px;margin:0;">--</p>
  </div>
  <div class="card" style="min-width:150px;flex:1;">
    <h3 style="margin:0 0 4px;font-size:12px;letter-spacing:.5px;text-transform:uppercase;">Threshold</h3>
    <p id="expThresh" style="font-size:20px;margin:0;">--</p>
  </div>
  <div class="card" style="min-width:150px;flex:1;">
    <h3 style="margin:0 0 4px;font-size:12px;letter-spacing:.5px;text-transform:uppercase;">Decision</h3>
    <p id="expDecision" style="font-size:20px;margin:0;">--</p>
  </div>
  <div class="card" style="min-width:200px;flex:1;">
    <h3 style="margin:0 0 4px;font-size:12px;letter-spacing:.5px;text-transform:uppercase;">Expected Base</h3>
    <p id="expBase" style="font-size:20px;margin:0;">--</p>
  </div>
  <div style="flex:1 1 100%;overflow-x:auto;">
    <div style="display:flex;align-items:center;gap:10px;margin-top:6px;flex-wrap:wrap;">
      <strong>Local Contributions</strong>
      <button id="downloadShapCsv" class="btn small" type="button" style="display:none;">Download CSV</button>
    </div>
    <table class="shap-table" id="shapTable" style="width:100%;border-collapse:collapse;margin-top:6px;min-width:640px;">
      <thead>
        <tr>
          <th data-key="feature" style="text-align:left;">Feature</th>
          <th data-key="value">Value</th>
          <th data-key="shap_value">SHAP</th>
          <th data-key="abs_shap">|SHAP|%</th>
          <th data-key="cum_pct">Cumlumative%</th>
          <th data-key="impact">Contribution Bar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="metricsContainer" class="metrics-grid"></div>

<div class="chart-row">
  <div class="chart-box">
    <h3>F1 / Precision / Recall Trend</h3>
    <canvas id="prChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Confusion Matrix Counts Trend</h3>
    <canvas id="cmChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Local SHAP (Last Sample)</h3>
    <canvas id="localShapChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Global SHAP Importance</h3>
    <canvas id="globalShapChart"></canvas>
  </div>
</div>

<h2 style="margin-top:40px;">Model Versions</h2>
<div id="versionsWrapper"><p>Loading versions...</p></div>
<div id="toastContainer"></div>

<h2 style="margin-top:40px;">Generated Plots</h2>
{% if plots %}
<div class="plots">
  {% for p in plots %}
    <div>
      <figure>
        <img src="/visualization/{{ p }}" alt="{{ p }}" />
        <figcaption style="font-size:12px;text-align:center;margin-top:4px;word-break:break-word;">{{ p }}</figcaption>
      </figure>
    </div>
  {% endfor %}
</div>
{% else %}
  <p>No plots found. Run the pipeline to generate visualizations.</p>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
const metricsContainer = document.getElementById('metricsContainer');
const lastTrainedEl = document.getElementById('lastTrained');
let refreshInterval = null;
const thresholdRange = document.getElementById('thresholdRange');
const thresholdValue = document.getElementById('thresholdValue');
if(thresholdRange){
  const updateTh = ()=>{ thresholdValue.textContent = parseFloat(thresholdRange.value).toFixed(2); };
  thresholdRange.addEventListener('input', updateTh); updateTh();
}

function renderMetrics(data){
  metricsContainer.innerHTML='';
  if(!data || Object.keys(data).length===0){
    metricsContainer.innerHTML = '<p>No metrics yet.</p>';return;
  }
  const order = ['precision','recall','f1_score','auc_roc','samples','features'];
  order.forEach(k=>{
    if(data[k]!==undefined){
      const div=document.createElement('div');div.className='metric';
      div.innerHTML=`<h3>${k.replace('_',' ')}</h3><p>${data[k]}</p>`;metricsContainer.appendChild(div);
    }
  });
  if(data.trained_at){ lastTrainedEl.textContent = 'Last Trained: '+data.trained_at; }
}

async function fetchMetrics(){
  try { const r = await fetch('/api/metrics'); const j = await r.json(); renderMetrics(j); }
  catch(e){ console.error(e); }
}

fetchMetrics();
let historyData = [];
let prChart = null; let cmChart = null; let lastLabelSignature = '';

async function fetchHistory(){
  try { const r = await fetch('/api/metrics/history'); historyData = await r.json(); buildCharts(); }
  catch(e){ console.error(e); }
}

function buildCharts(){
  if(!Array.isArray(historyData) || historyData.length===0) return;
  const sliceData = historyData.slice(-25); // cap
  const labels = sliceData.map(d=> (d.trained_at||'').replace('T',' ').slice(0,19));
  const labelSignature = labels.join('|');
  const precision = sliceData.map(d=> d.precision);
  const recall = sliceData.map(d=> d.recall);
  const f1 = sliceData.map(d=> d.f1_score);
  const tp = sliceData.map(d=> d.tp||0);
  const tn = sliceData.map(d=> d.tn||0);
  const fp = sliceData.map(d=> d.fp||0);
  const fn = sliceData.map(d=> d.fn||0);

  if(!prChart){
    prChart = new Chart(document.getElementById('prChart').getContext('2d'), {
      type:'line', data:{labels, datasets:[
        {label:'F1', data:f1, borderColor:'#3498db', tension:.25},
        {label:'Precision', data:precision, borderColor:'#2ecc71', tension:.25},
        {label:'Recall', data:recall, borderColor:'#e67e22', tension:.25}
      ]}, options:{responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true,max:1}}}
    });
  } else {
    if(labelSignature !== lastLabelSignature){
      prChart.data.labels = labels;
    }
    prChart.data.datasets[0].data = f1;
    prChart.data.datasets[1].data = precision;
    prChart.data.datasets[2].data = recall;
    prChart.update('none');
  }

  if(!cmChart){
    cmChart = new Chart(document.getElementById('cmChart').getContext('2d'), {
      type:'bar', data:{labels, datasets:[
        {label:'TP', data:tp, backgroundColor:'#2ecc71'},
        {label:'TN', data:tn, backgroundColor:'#3498db'},
        {label:'FP', data:fp, backgroundColor:'#e74c3c'},
        {label:'FN', data:fn, backgroundColor:'#f1c40f'}
      ]}, options:{responsive:true, maintainAspectRatio:false, animation:false, plugins:{legend:{position:'bottom'}}, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}}}
    });
  } else {
    if(labelSignature !== lastLabelSignature){
      cmChart.data.labels = labels;
    }
    cmChart.data.datasets[0].data = tp;
    cmChart.data.datasets[1].data = tn;
    cmChart.data.datasets[2].data = fp;
    cmChart.data.datasets[3].data = fn;
    cmChart.update('none');
  }
  lastLabelSignature = labelSignature;
}

// Download chosen version
const dlBtn = document.getElementById('downloadVersionBtn');
if(dlBtn){
  dlBtn.addEventListener('click', ()=>{
    const sel = document.getElementById('versionSelect');
    if(sel && sel.value){ window.location = '/download/version/'+ sel.value; }
  });
}

// Simple explanation fetch for random synthetic sample based on last metrics (placeholder fields)
const explainBtn = document.getElementById('explainSampleBtn');
let localShapChart=null; let globalShapChart=null;
let shapDataCurrent = []; // cache of current explanation rows
let shapSortState = {key:'abs_shap', dir:'desc'};
if(explainBtn){
  explainBtn.addEventListener('click', async ()=>{
    const payload = {packet_size:500, bytes_sent:1200, source_ip:'192.168.0.1', dest_ip:'192.168.0.2', protocol:'TCP', timestamp_seconds: Math.floor(Date.now()/1000), hour: new Date().getHours()};
    try {
      const params = new URLSearchParams({collapse_pairs:'true', n:'15'});
      const r = await fetch('/api/explain?'+params.toString(), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const j = await r.json();
      document.getElementById('explainResult').textContent = JSON.stringify(j, null, 2);
      if(j.features){
  renderExplainViz(j);
        const labels = j.features.map(f=>f.feature);
        const vals = j.features.map(f=>f.shap_value);
        if(!localShapChart){
          localShapChart = new Chart(document.getElementById('localShapChart').getContext('2d'), {type:'bar', data:{labels, datasets:[{label:'|SHAP| (signed)', data: vals, backgroundColor: vals.map(v=> v>=0?'#2ecc71':'#e74c3c')} ]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{ticks:{autoSkip:false}}}}});
        } else {
          localShapChart.data.labels = labels; localShapChart.data.datasets[0].data = vals; localShapChart.update('none');
        }
      }
    } catch(e){ document.getElementById('explainResult').textContent = e.toString(); }
  });
}

// Retrain buttons
const retrainBtn = document.getElementById('retrainBtn');
const retrainDataBtn = document.getElementById('retrainDataBtn');
const trainStatus = document.getElementById('trainStatus');
// Cancel button removed per user request; async training cannot be cancelled mid-run now.
async function triggerTrain(withData){
  retrainBtn.disabled = true; retrainDataBtn.disabled = true;
  const prev = trainStatus.textContent;
  trainStatus.innerHTML = 'Starting training <span class="spinner"></span>';
  const url = '/api/train/async'+(withData?'?generate_data=true':'');
  try { await fetch(url,{method:'POST'}); startSSE(); }
  catch(e){ trainStatus.textContent='Error starting: '+e.toString(); retrainBtn.disabled=false; retrainDataBtn.disabled=false; showToast('Failed to start training','error'); }
}
if(retrainBtn){ retrainBtn.addEventListener('click', ()=>triggerTrain(false)); }
if(retrainDataBtn){ retrainDataBtn.addEventListener('click', ()=>triggerTrain(true)); }
// Cancellation UI removed.

let evtSource = null;
function startSSE(){
  if(evtSource){ evtSource.close(); }
  evtSource = new EventSource('/api/train/events');
  evtSource.onmessage = async (ev)=>{
    try { const data = JSON.parse(ev.data); handleTrainEvent(data); } catch(e){}
  };
  evtSource.onerror = ()=>{ /* silent */ };
}
function handleTrainEvent(d){
  if(!d) return;
  if(d.error){ trainStatus.textContent = 'Error: '+d.error; retrainBtn.disabled=false; retrainDataBtn.disabled=false; showToast('Training failed: '+d.error,'error'); return; }
  const pct = (d.progress||0).toFixed(1);
  if(d.state==='completed'){ trainStatus.textContent='Completed 100%'; retrainBtn.disabled=false; retrainDataBtn.disabled=false; periodic(); loadVersions(); if(evtSource){evtSource.close();} showToast('Training complete','success'); }
  else if(d.state==='error'){ trainStatus.textContent='Training failed'; retrainBtn.disabled=false; retrainDataBtn.disabled=false; if(evtSource){evtSource.close();} showToast('Training failed','error'); }
  else if(d.state==='cancelled'){ trainStatus.textContent='Cancelled (legacy state)'; retrainBtn.disabled=false; retrainDataBtn.disabled=false; if(evtSource){evtSource.close();} showToast('Training cancelled','info'); }
  else { trainStatus.innerHTML = `${d.message||d.state} (${pct}%) <span class="spinner"></span>`; }
}

// Load versions
async function loadVersions(){
  try {
    const r = await fetch('/api/versions/detail');
    if(!r.ok) return;
    const arr = await r.json();
    const wrap = document.getElementById('versionsWrapper');
    if(!Array.isArray(arr) || !arr.length){ wrap.innerHTML = '<p>No versions yet.</p>'; return; }
    let html = '<table class="version-table"><thead><tr><th>Timestamp</th><th>F1</th><th>Prec</th><th>Rec</th><th>AUC</th><th>Dur(s)</th><th>Top SHAP</th><th>Actions</th></tr></thead><tbody>'; 
    arr.slice(0,10).forEach(v=>{
      const m = v.metrics||{};
      const shapTop = (m.shap_top||[]).slice(0,3).map(s=>s.feature).join(',');
      html += `<tr><td>${v.timestamp||''}</td><td>${m.f1_score||''}</td><td>${m.precision||''}</td><td>${m.recall||''}</td><td>${m.auc_roc||''}</td><td>${m.total_duration_sec?m.total_duration_sec.toFixed?m.total_duration_sec.toFixed(2):m.total_duration_sec:''}</td><td>${shapTop}</td><td><a href="/download/version/${v.model_file}" title="Download model">â¬‡</a> <button class="btn small rollbackBtn" data-ts="${v.timestamp||''}" style="padding:2px 6px;">Rollback</button></td></tr>`;
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;
    wrap.querySelectorAll('.rollbackBtn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const ts = btn.getAttribute('data-ts');
        if(!ts) return;
        if(!confirm('Rollback to model '+ts+'?')) return;
        try { const r = await fetch('/api/versions/rollback/'+ts,{method:'POST'}); const j = await r.json(); if(r.ok){ showToast('Rolled back to '+ts,'success'); periodic(); } else { showToast('Rollback failed: '+(j.error||r.status),'error'); } }
        catch(e){ showToast('Rollback error: '+e.toString(),'error'); }
      });
    });
  } catch(e){ document.getElementById('versionsWrapper').innerHTML = '<p>Error loading versions</p>'; }
}
loadVersions();

// Toast notifications
function showToast(msg,type='info', ttl=4000){
  const cont = document.getElementById('toastContainer'); if(!cont) return;
  const div = document.createElement('div'); div.className='toast '+type; div.textContent=msg; cont.appendChild(div);
  setTimeout(()=>{ div.style.transition='opacity .4s, transform .4s'; div.style.opacity='0'; div.style.transform='translateY(-6px)'; setTimeout(()=>div.remove(), 450); }, ttl);
}

async function loadGlobalShap(){
  try {
    const r = await fetch('/api/explain/global');
    if(!r.ok) return;
    const j = await r.json();
    if(j.items){
      const top = j.items.slice(0,15);
      const labels = top.map(i=>i.feature);
      const vals = top.map(i=>i.mean_abs_shap);
      if(!globalShapChart){
        globalShapChart = new Chart(document.getElementById('globalShapChart').getContext('2d'), {type:'bar', data:{labels, datasets:[{label:'Mean |SHAP|', data:vals, backgroundColor:'#8e44ad'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, indexAxis:'y'}});
      } else { globalShapChart.data.labels=labels; globalShapChart.data.datasets[0].data=vals; globalShapChart.update('none'); }
    }
  } catch(e){ /* ignore */ }
}
loadGlobalShap();

function renderExplainViz(j){
  const viz = document.getElementById('explainViz');
  if(!viz) return; viz.style.display='flex';
  const probEl = document.getElementById('expProb');
  const thrEl = document.getElementById('expThresh');
  const decEl = document.getElementById('expDecision');
  const baseEl = document.getElementById('expBase');
  if(j.probability!=null) probEl.textContent = j.probability.toFixed(3); else probEl.textContent='â€”';
  if(j.threshold!=null) thrEl.textContent = j.threshold.toFixed(2); else thrEl.textContent='â€”';
  if(j.decision!=null) decEl.textContent = j.decision===1?'Congested':'Normal'; else decEl.textContent='â€”';
  if(j.expected_value!=null) baseEl.textContent = Number(j.expected_value).toFixed(3); else baseEl.textContent='â€”';
  // Prepare data with abs & cumulative
  const raw = (j.features||[]).map(f=>({
    feature: f.feature,
    shap_value: f.shap_value||0,
    abs_shap: Math.abs(f.shap_value||0)
  }));
  const totalAbs = raw.reduce((a,b)=>a+b.abs_shap,0) || 1;
  // Sort by abs_shap desc default for cumulative
  raw.sort((a,b)=>b.abs_shap - a.abs_shap);
  let cum = 0;
  raw.forEach(r=>{cum += r.abs_shap; r.cum_pct = (cum/totalAbs)*100; r.pct = (r.abs_shap/totalAbs)*100;});
  // Attach original feature values
  raw.forEach(r=>{ r.value = (j.feature_values && j.feature_values[r.feature]!==undefined)? j.feature_values[r.feature]: ''; });
  shapDataCurrent = raw;
  shapSortState = {key:'abs_shap', dir:'desc'};
  renderShapTable();
  const dlBtn = document.getElementById('downloadShapCsv');
  if(dlBtn){ dlBtn.style.display='inline-block'; }
}

function sortShapData(key){
  if(shapSortState.key===key){ shapSortState.dir = shapSortState.dir==='asc'?'desc':'asc'; } else { shapSortState.key=key; shapSortState.dir='asc'; }
  const dir = shapSortState.dir==='asc'?1:-1;
  shapDataCurrent.sort((a,b)=>{
    const av = a[key]; const bv = b[key];
    if(av < bv) return -1*dir; if(av > bv) return 1*dir; return 0;
  });
  // Recompute cumulative if sorting breaks original order only when key!= 'cum_pct'
  if(key !== 'cum_pct'){
    let cum=0; const totalAbs = shapDataCurrent.reduce((s,r)=>s+r.abs_shap,0)||1;
    shapDataCurrent.forEach(r=>{ cum+=r.abs_shap; r.cum_pct = (cum/totalAbs)*100; r.pct = (r.abs_shap/totalAbs)*100; });
  }
  renderShapTable();
}

function renderShapTable(){
  const tbody = document.querySelector('#shapTable tbody');
  if(!tbody) return;
  tbody.innerHTML='';
  const headers = document.querySelectorAll('#shapTable thead th');
  headers.forEach(h=>{ h.classList.remove('sort-asc','sort-desc'); if(h.dataset.key===shapSortState.key){ h.classList.add(shapSortState.dir==='asc'?'sort-asc':'sort-desc'); } });
  shapDataCurrent.forEach(r=>{
    const shapv = r.shap_value;
    const tr = document.createElement('tr');
    const width = (r.abs_shap === 0)?0:r.pct; // percent contribution
    const color = shapv>=0?'#2ecc71':'#e74c3c';
    tr.innerHTML = `
      <td>${r.feature}</td>
      <td>${r.value}</td>
      <td style="color:${color};font-weight:600;">${shapv.toFixed(5)}</td>
      <td>${r.pct.toFixed(1)}%</td>
      <td><span class="cum-badge">${r.cum_pct.toFixed(1)}%</span></td>
      <td><div class="impact-wrap" title="|SHAP| ${r.abs_shap.toExponential(2)} (${r.pct.toFixed(1)}%)\nCum ${r.cum_pct.toFixed(1)}%"><div class="impact-fill" style="width:${width}%;background:${color};"></div></div></td>`;
    tbody.appendChild(tr);
  });
}

// Header click sorting
document.addEventListener('click', e=>{
  const th = e.target.closest('#shapTable thead th');
  if(!th || !th.dataset.key) return;
  const key = th.dataset.key;
  if(key==='impact') return; // skip bar
  sortShapData(key);
});

// CSV download
const shapCsvBtn = document.getElementById('downloadShapCsv');
if(shapCsvBtn){
  shapCsvBtn.addEventListener('click', ()=>{
    if(!shapDataCurrent.length) return;
    const header = ['feature','value','shap_value','abs_shap','percent','cumulative_percent'];
    const rows = shapDataCurrent.map(r=>[
      r.feature,
      typeof r.value==='number'? r.value: (r.value||''),
      r.shap_value,
      r.abs_shap,
      r.pct,
      r.cum_pct
    ]);
    const csv = [header.join(','), ...rows.map(r=>r.join(','))].join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'local_shap_explanation.csv';
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });
}

async function periodic(){
  await fetchMetrics();
  await fetchHistory();
}
periodic();
refreshInterval = setInterval(periodic, 15000); // 15s auto refresh
</script>
{% endblock %}
